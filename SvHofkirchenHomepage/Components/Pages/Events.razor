@page "/events"
@using SvHofkirchenHomepage.Models
@using SvHofkirchenHomepage.Services
@using System.Globalization
@inject DataService DataService

<PageTitle>Schachverein Hofkirchen - Termine</PageTitle>

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem" Style="margin: 20px;">
    <RadzenLabel Text="Archiv anzeigen:" Component="archiveToggle" />
    <RadzenSwitch @bind-Value="ShowArchive" Name="archiveToggle" Change="@OnArchiveToggle" />
</RadzenStack>

<div class="container mb-5" style="max-width: 900px;">
    @if (IsLoading)
    {
        <div class="text-center mt-5">
            <RadzenProgressBar Value="100" Mode="ProgressBarMode.Indeterminate" Style="width: 200px;" />
        </div>
    }
    else if (DisplayedEvents.Count == 0)
    {
        <div class="text-center mt-5 text-muted">
            <h3>Keine @(ShowArchive ? "vergangenen" : "anstehenden") Termine gefunden.</h3>
        </div>
    }
    else
    {
        <RadzenStack Gap="1.5rem">
            @foreach (var termin in DisplayedEvents)
            {
                <RadzenCard class="rz-p-4" Style="border-left: 5px solid #007bff;">
                    <RadzenStack Gap="0.5rem">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap">
                            <RadzenText TextStyle="TextStyle.H5" Style="margin: 0; color: #2c3e50; font-weight: bold;">
                                @termin.AppointmentTitle
                            </RadzenText>
                            <RadzenBadge BadgeStyle="@(ShowArchive ? BadgeStyle.Secondary : BadgeStyle.Success)" IsPill="true">
                                @termin.AppointmentDate @(string.IsNullOrWhiteSpace(termin.AppointmentTime) ? "" : $" - {termin.AppointmentTime}")
                            </RadzenBadge>
                        </RadzenStack>
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-text-secondary">
                            üìç <strong>Ort:</strong> @termin.AppointmentLocation
                        </RadzenText>
                        @if (!string.IsNullOrWhiteSpace(termin.AppointmentDescription))
                        {
                            <hr style="margin: 0.5rem 0; border-top: 1px dashed #ccc;" />
                            <RadzenText TextStyle="TextStyle.Body1">@termin.AppointmentDescription</RadzenText>
                        }
                    </RadzenStack>
                </RadzenCard>
            }
        </RadzenStack>
    }
</div>

@code {
    private bool IsLoading = true;
    private bool ShowArchive = false;
    private List<AppointmentDto> AllEvents = new();
    private List<AppointmentDto> DisplayedEvents = new();

    protected override async Task OnInitializedAsync()
    {
        try {
            var data = await DataService.GetDataAsync();
            if (data.Appointment != null) AllEvents = data.Appointment;
            FilterEvents();
        } finally { IsLoading = false; }
    }

    private void OnArchiveToggle() => FilterEvents();

    private void FilterEvents()
    {
        var today = DateTime.Today;
        DisplayedEvents = ShowArchive 
            ? AllEvents.Where(e => ParseDate(e.AppointmentDate) < today && ParseDate(e.AppointmentDate) != DateTime.MinValue).OrderByDescending(e => ParseDate(e.AppointmentDate)).ToList()
            : AllEvents.Where(e => ParseDate(e.AppointmentDate) >= today).OrderBy(e => ParseDate(e.AppointmentDate)).ToList();
    }

    private DateTime ParseDate(string dateStr)
    {
        string[] formats = { "dd.MM.yyyy", "dd-MM-yyyy", "yyyy-MM-dd", "M/d/yyyy" };
        if (DateTime.TryParseExact(dateStr, formats, CultureInfo.InvariantCulture, DateTimeStyles.None, out var date)) return date;
        return DateTime.MinValue;
    }
}