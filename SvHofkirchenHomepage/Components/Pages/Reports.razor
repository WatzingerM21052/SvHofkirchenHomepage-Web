@page "/reports"
@using SvHofkirchenHomepage.Models
@using SvHofkirchenHomepage.Services
@inject DataService DataService
@inject DialogService DialogService

<PageTitle>Berichte - SV Hofkirchen</PageTitle>

<RadzenStack Orientation="Orientation.Horizontal" 
             Gap="1rem" 
             Style="width: 100%; max-width: 800px; margin: 20px auto; padding: 0 10px;">
    
    <RadzenTextBox Placeholder="Suche..."
                   @bind-Value="SearchTerm"
                   @oninput="@(args => { SearchTerm = args.Value?.ToString() ?? ""; FilterReports(); })"
                   Style="flex-grow: 1;" />

    <RadzenDropDown Data="@CategoriesDropDown"
                    TextProperty="CategoryName"
                    ValueProperty="CategoryId"
                    Placeholder="Kategorie wÃ¤hlen"
                    @bind-Value="SelectedCategoryId"
                    Change="@(args => FilterReports())"
                    Style="width: 250px;" />
</RadzenStack>

@if (IsLoading)
{
    <div style="display: flex; justify-content: center; margin-top: 50px;">
        <RadzenProgressBar Value="100" Mode="ProgressBarMode.Indeterminate" Style="width: 200px;" />
    </div>
}
else if (FilteredReports.Count == 0)
{
    <RadzenText TextStyle="TextStyle.H5" 
                Style="text-align: center; margin-top: 50px; color: gray;">
        Keine Berichte gefunden.
    </RadzenText>
}
else
{
    <RadzenStack Orientation="Orientation.Horizontal"
                 Wrap="FlexWrap.Wrap"
                 JustifyContent="JustifyContent.Center"
                 Gap="1.5rem"
                 Style="max-width: 1200px; margin: 20px auto 40px auto;">
        
        @foreach (var item in FilteredReports)
        {
            <RadzenCard Variant="Variant.Filled" 
                        Style="width: 375px; height: 280px; padding: 0; overflow: hidden; position: relative; cursor: pointer;"
                        @onclick="() => OpenReportDetail(item)">
                
                <div style="width: 100%; height: 100%; background-color: #eee;">
                    @if (!string.IsNullOrEmpty(item.MainImageUrl))
                    {
                        <img src="@item.MainImageUrl" 
                             alt="Titelbild"
                             style="width: 100%; height: 100%; object-fit: cover;" />
                    }
                    else
                    {
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ccc;">
                            <RadzenIcon Icon="image_not_supported" Style="font-size: 4rem;" />
                        </div>
                    }
                </div>

                <RadzenStack Orientation="Orientation.Vertical" 
                             Gap="0"
                             Style="position: absolute; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); padding: 1rem;">
                    
                    <RadzenText TextStyle="TextStyle.Body1" Style="color: white; font-weight: bold; margin-bottom: 0.2rem;">
                        @LimitLength(item.Report.ReportTitle, 35)
                    </RadzenText>
                    
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenText TextStyle="TextStyle.Caption" Style="color: #ddd;">
                            @item.CategoryName
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption" Style="color: #ddd;">
                            @item.Report.ReportAboutDate
                        </RadzenText>
                    </RadzenStack>
                </RadzenStack>

            </RadzenCard>
        }
    </RadzenStack>
}

@code {
    private bool IsLoading = true;
    private string SearchTerm = "";
    private int SelectedCategoryId = -1;

    private List<CategoryDto> Categories = new();
    private List<CategoryDto> CategoriesDropDown = new();
    private List<ReportViewModel> AllReports = new();
    private List<ReportViewModel> FilteredReports = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var data = await DataService.GetDataAsync();
            Categories = data.Category ?? new();

            CategoriesDropDown = new List<CategoryDto> 
            { 
                new CategoryDto { CategoryId = -1, CategoryName = "Alle Kategorien" } 
            };
            CategoriesDropDown.AddRange(Categories);

            if (data.Report != null)
            {
                foreach (var report in data.Report)
                {
                    var imageIds = data.ReportImage?
                        .Where(ri => ri.ReportId == report.ReportId)
                        .Select(ri => ri.ImageId)
                        .ToList() ?? new List<int>();

                    var imageUrls = data.Image?
                        .Where(img => imageIds.Contains(img.ImageId))
                        .Select(img => img.ImagePath)
                        .ToList() ?? new List<string>();

                    var catName = Categories.FirstOrDefault(c => c.CategoryId == report.CategoryId)?.CategoryName ?? "Allgemein";

                    AllReports.Add(new ReportViewModel
                    {
                        Report = report,
                        CategoryName = catName,
                        MainImageUrl = imageUrls.FirstOrDefault(),
                        AllImageUrls = imageUrls
                    });
                }
            }
            AllReports.Reverse();
            FilterReports();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fehler: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void FilterReports()
    {
        var query = AllReports.AsEnumerable();
        if (SelectedCategoryId != -1)
            query = query.Where(r => r.Report.CategoryId == SelectedCategoryId);
        if (!string.IsNullOrWhiteSpace(SearchTerm))
            query = query.Where(r => (r.Report.ReportTitle ?? "").Contains(SearchTerm, StringComparison.OrdinalIgnoreCase));
        FilteredReports = query.ToList();
    }

    private void OpenReportDetail(ReportViewModel item)
    {
        DialogService.OpenAsync(item.Report.ReportTitle, ds => 
            @<RadzenStack Style="width: 100%; max-height: 80vh; overflow-y: auto;">
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="@item.CategoryName" />
                    <RadzenText TextStyle="TextStyle.Caption">@item.Report.ReportAboutDate</RadzenText>
                </RadzenStack>
                <div class="rz-p-2">@((MarkupString)(item.Report.ReportText ?? ""))</div>
                 @if (item.AllImageUrls.Any())
                {
                    <RadzenStack Orientation="Orientation.Horizontal" Style="overflow-x: auto;" Gap="10px">
                        @foreach (var imgPath in item.AllImageUrls) { <RadzenImage Path="@imgPath" Style="height: 150px; border-radius: 8px;" /> }
                    </RadzenStack>
                }
            </RadzenStack>,
            new DialogOptions { Width = "90%", CloseDialogOnOverlayClick = true, ShowClose = true }
        );
    }

    private string LimitLength(string? text, int max) => (text?.Length ?? 0) > max ? text!.Substring(0, max) + "..." : (text ?? "");

    public class ReportViewModel
    {
        public ReportDto Report { get; set; } = new();
        public string CategoryName { get; set; } = "";
        public string? MainImageUrl { get; set; }
        public List<string> AllImageUrls { get; set; } = new();
    }
}