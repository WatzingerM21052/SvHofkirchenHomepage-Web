@page "/attendance"
@inject YouthService Service

<h3><i class="bi bi-check2-square"></i> Anwesenheit erfassen</h3>

@if (!Service.IsInitialized)
{
    <p>Lade Daten...</p>
}
else
{
    <div class="card p-3 mb-3 bg-light">
        <label>Datum auswählen:</label>
        <input type="date" class="form-control" style="max-width: 200px;" 
               value="@CurrentDate.ToString("yyyy-MM-dd")" 
               @onchange="OnDateChanged" />
    </div>

    <div class="list-group">
        @foreach (var member in Service.YouthMembers.OrderBy(m => m.LastName))
        {
            var isPresent = Service.IsPresent(member.MemberId, CurrentDate);
            
            <div class="list-group-item d-flex justify-content-between align-items-center @(isPresent ? "list-group-item-success" : "")" 
                 @onclick="() => Toggle(member.MemberId)" 
                 style="cursor: pointer;">
                
                <div>
                    <strong>@member.LastName @member.FirstName</strong>
                    <br/>
                    <small class="text-muted">Alter: @member.Age</small>
                </div>

                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" checked="@isPresent" style="pointer-events: none;">
                </div>
            </div>
        }
    </div>
    
    <div class="mt-4 alert alert-info">
        Änderungen werden automatisch im Browser gespeichert. <br/>
        <button class="btn btn-sm btn-dark mt-2" @onclick="Service.DownloadDataAsync">
            Datenbank herunterladen (Backup)
        </button>
    </div>
}

@code {
    private DateTime CurrentDate = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        await Service.InitializeAsync();
    }

    private void OnDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            CurrentDate = date;
        }
    }

    private async Task Toggle(int memberId)
    {
        await Service.TogglePresenceAsync(memberId, CurrentDate);
    }
}