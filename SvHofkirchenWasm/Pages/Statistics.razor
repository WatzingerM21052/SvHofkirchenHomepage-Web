@page "/statistics"
@using SvHofkirchenWasm.Models
@inject YouthService Service
@inject IJSRuntime JS

<div class="container-fluid pb-5 p-4">
    <h3 class="mb-4 fw-bold text-primary"><i class="bi bi-bar-chart-fill me-2"></i>Statistik Dashboard</h3>

    @if (!Service.IsInitialized)
    {
         <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
    }
    else
    {
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="glass-card p-3 h-100 border-0">
                    <h6 class="text-uppercase text-muted fw-bold small mb-3">Altersklassen</h6>
                    <div style="height: 250px; position: relative;">
                        <canvas id="ageChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="glass-card p-3 h-100 border-0">
                    <h6 class="text-uppercase text-muted fw-bold small mb-3">Teilnahmeverlauf (Letzte 12 Monate)</h6>
                    <div style="height: 250px; position: relative;">
                        <canvas id="monthChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-7">
                <div class="glass-card border-0">
                    <div class="card-header bg-white border-bottom p-3 d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0 text-primary">üèÜ Trainingsflei√ü</h5>
                        <button class="btn btn-sm btn-outline-danger" @onclick="ExportPdf">
                            <i class="bi bi-file-earmark-pdf-fill me-1"></i> PDF Export
                        </button>
                    </div>
                    
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light sticky-top" style="z-index: 1;">
                                <tr>
                                    <th class="ps-4">Rang</th>
                                    <th>Name</th>
                                    <th>Kategorie</th>
                                    <th class="text-center">Trainings</th>
                                    <th class="text-end pe-4">Quote</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{ var rank = 1; }
                                @foreach (var stat in GetFullAttendanceList())
                                {
                                    <tr class="stat-rank-row">
                                        <td class="ps-4 fw-bold text-muted">#@rank</td>
                                        <td>
                                            <span class="fw-bold text-dark">@stat.Name</span>
                                        </td>
                                        <td><span class="badge rounded-pill @stat.Color" style="font-size: 0.7rem;">@stat.Category</span></td>
                                        <td class="text-center fw-bold fs-5 text-primary">@stat.Count</td>
                                        <td class="text-end pe-4">
                                            <div class="d-flex align-items-center justify-content-end gap-2">
                                                <div class="progress" style="width: 60px; height: 6px;">
                                                    <div class="progress-bar bg-primary" role="progressbar" style="width: @(stat.Percentage)%"></div>
                                                </div>
                                                <small class="text-muted" style="width: 35px;">@(Math.Round(stat.Percentage))%</small>
                                            </div>
                                        </td>
                                    </tr>
                                    rank++;
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <h5 class="fw-bold text-primary mb-3 ps-2">üìÖ Die letzten 5 Trainings</h5>
                <div class="d-flex flex-column">
                     @foreach(var day in GetLastTrainings())
                     {
                         <div class="training-step-card d-flex justify-content-between align-items-center">
                             <div>
                                 <div class="d-flex align-items-center gap-2 mb-1">
                                     <i class="bi bi-calendar-event text-muted"></i>
                                     <span class="fw-bold text-dark">@day.Date.ToString("dd. MMMM yyyy")</span>
                                 </div>
                                 <div class="small text-muted">
                                     Trainingsbeteiligung
                                 </div>
                             </div>
                             <div class="text-end">
                                 <span class="display-6 fw-bold text-primary">@day.Count</span>
                                 <span class="d-block small text-muted">Teilnehmer</span>
                             </div>
                         </div>
                     }
                     @if(!GetLastTrainings().Any())
                     {
                         <div class="alert alert-secondary border-0">Noch keine Trainingsdaten vorhanden.</div>
                     }
                </div>
            </div>
        </div>
    }
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        Service.OnChange += StateHasChanged;
        await Service.InitializeAsync();
    }
    
    public void Dispose() => Service.OnChange -= StateHasChanged;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Service.IsInitialized)
        {
            // Kleines Delay damit Canvas sicher da ist
            await Task.Delay(100); 
            await RenderCharts();
        }
    }

    private IEnumerable<(string Name, string Category, string Color, int Count, double Percentage)> GetFullAttendanceList()
    {
        int totalTrainings = Service.Presences.Select(p => p.ParsedDate.Date).Distinct().Count();
        if (totalTrainings == 0) totalTrainings = 1;

        return Service.YouthMembers
            .Select(m => {
                int count = Service.Presences.Count(p => p.MemberId == m.MemberId);
                return new {
                    Member = m,
                    Count = count,
                    Percentage = (double)count / totalTrainings * 100
                };
            })
            .OrderByDescending(x => x.Count)
            .ThenBy(x => x.Member.LastName)
            .Select(x => (
                x.Member.FullName, 
                x.Member.AgeCategory, 
                x.Member.CategoryColor, 
                x.Count, 
                x.Percentage
            ));
    }

    private IEnumerable<(DateTime Date, int Count)> GetLastTrainings()
    {
        return Service.Presences
            .GroupBy(p => p.ParsedDate.Date)
            .OrderByDescending(g => g.Key)
            .Take(5)
            .Select(g => (g.Key, g.Count()));
    }

    private async Task ExportPdf()
    {
        var list = GetFullAttendanceList().ToList();
        if(!list.Any()) return;

        var data = list.Select(x => new string[] { 
            x.Name, 
            x.Category, 
            x.Count.ToString(), 
            Math.Round(x.Percentage) + "%" 
        }).ToList();

        var headers = new string[] { "Name", "Kategorie", "Anzahl", "Quote" };

        await JS.InvokeVoidAsync("generatePdf", "Trainingsstatistik SV Hofkirchen", headers, data);
    }

    private async Task RenderCharts()
    {
        // FIX: Sortierung nach L√§nge (damit U8 vor U10 kommt) und dann Alphabet
        var categories = Service.YouthMembers
            .GroupBy(m => m.AgeCategory)
            .OrderBy(g => g.Key.Length) // U8 (2 chars) vor U10 (3 chars)
            .ThenBy(g => g.Key)
            .ToList();

        var ageConfig = new
        {
            type = "doughnut",
            data = new
            {
                labels = categories.Select(g => g.Key).ToArray(),
                datasets = new[] {
                    new {
                        data = categories.Select(g => g.Count()).ToArray(),
                        backgroundColor = new[] { "#198754", "#0dcaf0", "#0d6efd", "#ffc107", "#dc3545", "#212529", "#6c757d" },
                        borderWidth = 0
                    }
                }
            },
            options = new { 
                plugins = new { legend = new { position = "right" } },
                cutout = "70%",
                responsive = true,
                maintainAspectRatio = false
            }
        };

        var months = Service.Presences
            .Where(p => p.ParsedDate > DateTime.Today.AddMonths(-12))
            .GroupBy(p => new { p.ParsedDate.Year, p.ParsedDate.Month })
            .OrderBy(g => g.Key.Year).ThenBy(g => g.Key.Month)
            .ToList();

        var monthConfig = new 
        {
            type = "bar",
            data = new 
            {
                labels = months.Select(g => $"{g.Key.Month}/{g.Key.Year}").ToArray(),
                datasets = new[] {
                    new {
                        label = "Teilnehmer",
                        data = months.Select(g => g.Count()).ToArray(),
                        backgroundColor = "#052767",
                        borderRadius = 4,
                        barThickness = 20
                    }
                }
            },
            options = new { 
                responsive = true,
                maintainAspectRatio = false,
                plugins = new { legend = new { display = false } },
                scales = new { 
                    y = new { beginAtZero = true, grid = new { display = false } },
                    x = new { grid = new { display = false } }
                }
            }
        };

        await JS.InvokeVoidAsync("setupChart", "ageChart", ageConfig);
        await JS.InvokeVoidAsync("setupChart", "monthChart", monthConfig);
    }
}