@page "/statistics"
@inject YouthService Service

<h3><i class="bi bi-bar-chart-fill"></i> Statistik</h3>

@if (Service.IsInitialized)
{
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">Flei√üigste Teilnehmer (Top 10)</div>
                <ul class="list-group list-group-flush">
                    @foreach (var stat in GetTopAttendees())
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            @stat.Name
                            <span class="badge bg-primary rounded-pill">@stat.Count x</span>
                        </li>
                    }
                </ul>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">Letzte 5 Trainingstage</div>
                <div class="card-body">
                   @foreach(var day in GetLastTrainings())
                   {
                       <div class="mb-2">
                           <div class="d-flex justify-content-between">
                               <span>@day.Date.ToShortDateString()</span>
                               <span>@day.Count Teilnehmer</span>
                           </div>
                           <div class="progress" style="height: 10px;">
                               <div class="progress-bar bg-success" role="progressbar" style="width: @(day.Percentage)%"></div>
                           </div>
                       </div>
                   }
                </div>
            </div>
        </div>
    </div>
}

@code {
    protected override async Task OnInitializedAsync()
    {
        await Service.InitializeAsync();
    }

    private IEnumerable<(string Name, int Count)> GetTopAttendees()
    {
        return Service.Presences
            .GroupBy(p => p.MemberId)
            .Select(g => new { 
                Member = Service.YouthMembers.FirstOrDefault(m => m.MemberId == g.Key), 
                Count = g.Count() 
            })
            .Where(x => x.Member != null)
            .Select(x => (x.Member!.FullName, x.Count))
            .OrderByDescending(x => x.Count)
            .Take(10);
    }

    private IEnumerable<(DateTime Date, int Count, double Percentage)> GetLastTrainings()
    {
        var totalMembers = Service.YouthMembers.Count;
        if (totalMembers == 0) return Enumerable.Empty<(DateTime, int, double)>();

        return Service.Presences
            .GroupBy(p => p.ParsedDate.Date)
            .OrderByDescending(g => g.Key)
            .Take(5)
            .Select(g => (
                g.Key, 
                g.Count(), 
                (double)g.Count() / totalMembers * 100
            ));
    }
}