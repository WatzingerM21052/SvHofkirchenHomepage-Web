@page "/statistics"
@using SvHofkirchenWasm.Models
@using System.Globalization
@inject YouthService Service
@inject IJSRuntime JS

<div class="container-fluid pb-5 p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary mb-0">Statistiken</h2>
            <p class="text-muted small mb-0">Datenanalyse Saison 2025/26</p>
        </div>
        @if (Service.IsInitialized)
        {
            <button class="btn btn-outline-danger btn-sm rounded-pill px-3 fw-bold transition-hover" @onclick="ExportPdf">
                <i class="bi bi-file-earmark-pdf me-1"></i> PDF Report
            </button>
        }
    </div>

    @if (!Service.IsInitialized)
    {
         <div class="d-flex justify-content-center py-5">
             <div class="spinner-border text-primary"></div>
         </div>
    }
    else
    {
        <div class="row g-4 mb-4">
            <div class="col-lg-4 col-md-6">
                <div class="glass-card p-4 h-100 position-relative">
                    <h6 class="text-uppercase text-muted fw-bold small mb-4">Altersstruktur</h6>
                    <div style="height: 220px; position: relative;">
                        <canvas id="ageChart"></canvas>
                    </div>
                    <div class="mt-4 d-flex justify-content-center gap-3">
                         <div class="text-center">
                             <h4 class="mb-0 fw-bold">@Service.YouthMembers.Count</h4>
                             <small class="text-muted">Kader</small>
                         </div>
                         <div class="vr"></div>
                         <div class="text-center">
                             <h4 class="mb-0 fw-bold">@GetActiveMembersCount()</h4>
                             <small class="text-muted">Aktiv</small>
                         </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8 col-md-6">
                <div class="glass-card p-4 h-100">
                    <h6 class="text-uppercase text-muted fw-bold small mb-4">Trainingstrend (12 Monate)</h6>
                    <div style="height: 220px; position: relative;">
                        <canvas id="monthChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="glass-card h-100 border-0 overflow-hidden">
                    <div class="p-3 border-bottom bg-white d-flex align-items-center justify-content-between">
                        <h6 class="fw-bold text-primary mb-0"><i class="bi bi-trophy-fill me-2"></i>Top TrainingsfleiÃŸ</h6>
                        <span class="badge bg-light text-dark border">Gesamt</span>
                    </div>
                    
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light sticky-top" style="z-index: 5;">
                                <tr>
                                    <th class="ps-4">Rang</th>
                                    <th>Name</th>
                                    <th>Kat.</th>
                                    <th class="text-center">Trainings</th>
                                    <th class="text-end pe-4">Quote</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{ var rank = 1; }
                                @foreach (var stat in GetFullAttendanceList())
                                {
                                    <tr>
                                        <td class="ps-4 fw-bold" style="width:60px;">
                                            @if(rank == 1) { <span class="fs-4">ðŸ¥‡</span> }
                                            else if(rank == 2) { <span class="fs-4">ðŸ¥ˆ</span> }
                                            else if(rank == 3) { <span class="fs-4">ðŸ¥‰</span> }
                                            else { <span class="text-muted">#@rank</span> }
                                        </td>
                                        <td>
                                            <div class="fw-bold text-dark">@stat.Name</div>
                                        </td>
                                        <td><span class="badge rounded-pill @stat.Color border border-white">@stat.Category</span></td>
                                        <td class="text-center">
                                            <span class="fw-bold text-primary">@stat.Count</span>
                                        </td>
                                        <td class="text-end pe-4">
                                            <div class="d-flex align-items-center justify-content-end gap-2">
                                                <div class="progress flex-grow-1" style="height: 6px; width: 80px; border-radius: 10px;">
                                                    <div class="progress-bar bg-gradient-primary" role="progressbar" 
                                                         style="width: @(stat.Percentage.ToString("0.0", CultureInfo.InvariantCulture))%"></div>
                                                </div>
                                                <small class="fw-bold text-muted">@(Math.Round(stat.Percentage))%</small>
                                            </div>
                                        </td>
                                    </tr>
                                    rank++;
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <h6 class="text-uppercase text-muted fw-bold small mb-3 ps-1">Letzte Einheiten</h6>
                <div class="d-flex flex-column gap-3">
                     @foreach(var day in GetLastTrainings())
                     {
                         <div class="glass-card p-3 d-flex align-items-center transition-hover">
                             <div class="bg-primary bg-gradient text-white p-3 rounded-3 me-3 d-flex flex-column align-items-center justify-content-center shadow-sm" style="width: 60px; height: 60px;">
                                 <span class="small fw-bold text-uppercase" style="font-size: 0.65rem;">@day.Date.ToString("MMM")</span>
                                 <span class="fs-4 fw-bold lh-1">@day.Date.Day</span>
                             </div>
                             <div class="flex-grow-1">
                                 <h6 class="fw-bold mb-0 text-dark">Training</h6>
                                 <small class="text-muted">@day.Date.ToString("dddd")</small>
                             </div>
                             <div class="text-end">
                                 <span class="badge bg-light text-primary border fs-6">@day.Count <i class="bi bi-person-fill"></i></span>
                             </div>
                         </div>
                     }
                     @if(!GetLastTrainings().Any())
                     {
                         <div class="alert alert-light border text-center text-muted">Keine Daten.</div>
                     }
                </div>
            </div>
        </div>
    }
</div>

<style>
    /* Kleiner Custom Helper fÃ¼r Verlauf */
    .bg-gradient-primary {
        background: linear-gradient(90deg, var(--primary) 0%, #0d6efd 100%);
    }
    .btn-icon {
        width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center;
    }
    .btn-icon:hover { background-color: #e9ecef; }
</style>

@code {
    // ... Code fÃ¼r Charts, PDF Export und Data Fetching bleibt exakt gleich wie in deinem vorigen Snippet ...
    // ... (Kopiere die Methoden GetFullAttendanceList, GetLastTrainings, ExportPdf, RenderCharts hier rein) ...
    // Ich fÃ¼ge nur die fehlende Methode hinzu:
    
    private int GetActiveMembersCount()
    {
        // Als "Aktiv" zÃ¤hlt, wer in den letzten 3 Monaten da war
        var threeMonthsAgo = DateTime.Today.AddMonths(-3);
        var activeIds = Service.Presences.Where(p => p.ParsedDate >= threeMonthsAgo).Select(p => p.MemberId).Distinct();
        return activeIds.Count();
    }
    
    // --- HIER DEINE VORHERIGEN METHODEN EINFÃœGEN ---
     protected override async Task OnInitializedAsync()
    {
        Service.OnChange += StateHasChanged;
        await Service.InitializeAsync();
    }
    public void Dispose() => Service.OnChange -= StateHasChanged;
    protected override async Task OnAfterRenderAsync(bool firstRender) { if (Service.IsInitialized) { await Task.Delay(100); await RenderCharts(); } }
    
    private IEnumerable<(string Name, string Category, string Color, int Count, double Percentage)> GetFullAttendanceList()
    {
        int totalTrainings = Service.Presences.Select(p => p.ParsedDate.Date).Distinct().Count();
        if (totalTrainings == 0) totalTrainings = 1;
        return Service.YouthMembers.Select(m => { int count = Service.Presences.Count(p => p.MemberId == m.MemberId); return new { Member = m, Count = count, Percentage = (double)count / totalTrainings * 100 }; }).OrderByDescending(x => x.Count).ThenBy(x => x.Member.LastName).Select(x => (x.Member.FullName, x.Member.AgeCategory, x.Member.CategoryColor, x.Count, x.Percentage));
    }
    private IEnumerable<(DateTime Date, int Count)> GetLastTrainings()
    {
        return Service.Presences.GroupBy(p => p.ParsedDate.Date).OrderByDescending(g => g.Key).Take(5).Select(g => (g.Key, g.Count()));
    }
    private async Task ExportPdf()
    {
        var list = GetFullAttendanceList().ToList(); if(!list.Any()) return;
        var data = list.Select(x => new string[] { x.Name, x.Category, x.Count.ToString(), Math.Round(x.Percentage) + "%" }).ToList();
        var headers = new string[] { "Name", "Kategorie", "Anzahl", "Quote" };
        await JS.InvokeVoidAsync("generatePdf", "Trainingsstatistik", headers, data);
    }
    private async Task RenderCharts()
    {
        var categories = Service.YouthMembers.GroupBy(m => m.AgeCategory).OrderBy(g => g.Key.Length).ThenBy(g => g.Key).ToList();
        
        var ageDataset = new[] { new { data = categories.Select(g => g.Count()).ToArray(), backgroundColor = new[] { "#198754", "#0dcaf0", "#0d6efd", "#ffc107", "#dc3545", "#212529", "#6c757d" }, borderWidth = 0 } };
        var ageData = new { labels = categories.Select(g => g.Key).ToArray(), datasets = ageDataset };
        var ageOptions = new { plugins = new { legend = new { position = "right" } }, cutout = "70%", maintainAspectRatio = false };
        var ageConfig = new { type = "doughnut", data = ageData, options = ageOptions };
        
        var months = Service.Presences.Where(p => p.ParsedDate > DateTime.Today.AddMonths(-12)).GroupBy(p => new { p.ParsedDate.Year, p.ParsedDate.Month }).OrderBy(g => g.Key.Year).ThenBy(g => g.Key.Month).ToList();
        
        var monthDataset = new[] { new { label = "Teilnehmer", data = months.Select(g => g.Count()).ToArray(), backgroundColor = "#052767", borderRadius = 4, barThickness = 20 } };
        var monthData = new { labels = months.Select(g => $"{g.Key.Month}/{g.Key.Year}").ToArray(), datasets = monthDataset };
        var monthScales = new { y = new { beginAtZero = true, grid = new { display = false } }, x = new { grid = new { display = false } } };
        var monthOptions = new { maintainAspectRatio = false, plugins = new { legend = new { display = false } }, scales = monthScales };
        var monthConfig = new { type = "bar", data = monthData, options = monthOptions };
        
        await JS.InvokeVoidAsync("setupChart", "ageChart", ageConfig);
        await JS.InvokeVoidAsync("setupChart", "monthChart", monthConfig);
    }
}