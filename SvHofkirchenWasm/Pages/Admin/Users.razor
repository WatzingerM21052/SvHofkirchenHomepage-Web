@page "/admin/users"
@using SvHofkirchenWasm.Services
@using SvHofkirchenWasm.Models
@inject AuthService AuthService
@inject NavigationManager Navigation

@if (AuthService.CurrentRole != "Admin")
{
    <div class="alert alert-danger" role="alert">
        <strong>Zugriff verweigert!</strong> Diese Seite ist nur für Administratoren zugänglich.
    </div>
    return;
}

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2>
                <i class="bi bi-shield-lock me-2"></i>Benutzerverwaltung
            </h2>
        </div>
        <div class="col text-end">
            <button class="btn btn-primary" @onclick="ShowCreateUserModal">
                <i class="bi bi-plus-circle me-2"></i>Neuer Benutzer
            </button>
        </div>
    </div>

    @if (UserList.Count == 0)
    {
        <div class="alert alert-info" role="alert">
            Noch keine Benutzer erstellt.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Benutzername</th>
                        <th>Email</th>
                        <th>Rolle</th>
                        <th>Status</th>
                        <th>Erstellt am</th>
                        <th>Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in UserList)
                    {
                        <tr>
                            <td><strong>@user.UserName</strong></td>
                            <td>@user.Email</td>
                            <td>
                                <span class="badge" style="@GetRoleBadgeStyle(user.Role)">
                                    @user.Role
                                </span>
                            </td>
                            <td>
                                @if (user.IsActive)
                                {
                                    <span class="badge bg-success">Aktiv</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Inaktiv</span>
                                }
                            </td>
                            <td>@user.CreatedAt.ToString("dd.MM.yyyy HH:mm")</td>
                            <td>
                                <button class="btn btn-sm btn-warning" @onclick="@(() => EditUser(user))">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="@(() => DeleteUser(user.UserId))">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- Modal für Benutzer erstellen/bearbeiten -->
@if (ShowModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(EditingUser?.UserId == 0 ? "Neuer Benutzer" : "Benutzer bearbeiten")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label for="userName" class="form-label">Benutzername</label>
                            <input type="text" class="form-control" id="userName" @bind="EditingUser.UserName" />
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" @bind="EditingUser.Email" />
                        </div>
                        <div class="mb-3">
                            <label for="role" class="form-label">Rolle</label>
                            <select class="form-select" id="role" @bind="EditingUser.Role">
                                <option value="Admin">Admin</option>
                                <option value="Trainer">Trainer</option>
                                <option value="Mitglied">Mitglied</option>
                                <option value="Besucher">Besucher</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="isActive" class="form-label">
                                <input type="checkbox" id="isActive" @bind="EditingUser.IsActive" />
                                Aktiv
                            </label>
                        </div>
                        @if (EditingUser.UserId == 0)
                        {
                            <div class="alert alert-info small">
                                <strong>Passwort:</strong> Wird automatisch generiert und dem Benutzer mitgeteilt.
                            </div>
                        }
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveUser">Speichern</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<User> UserList = new();
    private bool ShowModal = false;
    private User EditingUser = new();

    protected override void OnInitialized()
    {
        LoadUsers();
    }

    private void LoadUsers()
    {
        // TODO: Von API laden
        UserList = new List<User>
{
new User
{
UserId = 1,
UserName = "admin",
Email = "schachverein.hofkirchen@gmx.at",
Role = "Admin",
IsActive = true,
CreatedAt = DateTime.Now.AddDays(-30),
LastLogin = DateTime.Now
}
};
    }

    private void ShowCreateUserModal()
    {
        EditingUser = new User { UserId = 0, CreatedAt = DateTime.Now };
        ShowModal = true;
    }

    private void EditUser(User user)
    {
        EditingUser = new User
        {
            UserId = user.UserId,
            UserName = user.UserName,
            Email = user.Email,
            Role = user.Role,
            IsActive = user.IsActive,
            CreatedAt = user.CreatedAt,
            LastLogin = user.LastLogin
        };
        ShowModal = true;
    }

    private void SaveUser()
    {
        if (EditingUser.UserId == 0)
        {
            // Neuer Benutzer
            EditingUser.UserId = UserList.Max(u => u.UserId) + 1;
            UserList.Add(EditingUser);
        }
        else
        {
            // Benutzer aktualisieren
            var existingUser = UserList.First(u => u.UserId == EditingUser.UserId);
            existingUser.UserName = EditingUser.UserName;
            existingUser.Email = EditingUser.Email;
            existingUser.Role = EditingUser.Role;
            existingUser.IsActive = EditingUser.IsActive;
        }

        CloseModal();
        // TODO: API-Call zum Speichern
    }

    private void DeleteUser(int userId)
    {
        if (userId == 1)
        {
            // Admin-User nicht löschen
            return;
        }

        UserList.RemoveAll(u => u.UserId == userId);
        // TODO: API-Call zum Löschen
    }

    private void CloseModal()
    {
        ShowModal = false;
        EditingUser = new();
    }

    private string GetRoleBadgeStyle(string role) => role switch
    {
        "Admin" => "background-color: #dc3545;",
        "Trainer" => "background-color: #0d6efd;",
        "Mitglied" => "background-color: #198754;",
        "Besucher" => "background-color: #6c757d;",
        _ => "background-color: #6c757d;"
    };
}