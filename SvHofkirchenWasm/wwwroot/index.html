<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SV Hofkirchen - Jugend</title>
    
    <script>
        // CRITICAL FIX: Prevent storage access errors (localStorage, sessionStorage, caches)
        (function() {
            const noop = () => {};
            const storageShim = {
                getItem: () => null, setItem: noop, removeItem: noop, 
                clear: noop, key: () => null, length: 0
            };
            
            try {
                // Shim localStorage & sessionStorage
                Object.defineProperty(window, 'localStorage', { value: storageShim, writable: false });
                Object.defineProperty(window, 'sessionStorage', { value: storageShim, writable: false });
            } catch (e) { console.warn("Storage shim failed", e); }

            // Shim Cache API (used by Blazor boot)
            if (!window.caches) {
                window.caches = { match: () => Promise.resolve(undefined), open: () => Promise.resolve({ add: noop, put: noop, match: () => Promise.resolve(undefined) }) };
            }
        })();
    </script>
    
    <base href="/" /> 
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">
    <link rel="stylesheet" href="css/app.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="SvHofkirchenWasm.styles.css" rel="stylesheet" />
</head>

<body>
    <div id="app">
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999;">
            <div class="spinner-border" role="status" style="width: 3rem; height: 3rem; color: #052767;"></div>
            <h4 class="mt-4" style="color: #052767;">Lade Vereinsdaten...</h4>
        </div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">ðŸ—™</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/de.js"></script>

    <script>
        // Suppress unhandled errors from storage/network to prevent crash UI
        window.addEventListener('error', (e) => {
            if (e.message && (e.message.includes('storage') || e.message.includes('503'))) {
                e.stopImmediatePropagation();
                e.preventDefault();
                console.warn("Suppressing critical error:", e.message);
            }
        });
        window.addEventListener('unhandledrejection', (e) => {
            const msg = e.reason ? e.reason.toString() : '';
            if (msg.includes('storage') || msg.includes('503') || msg.includes('Failed to fetch')) {
                e.preventDefault();
            }
        });

        // JS Helpers
        window.setupChart = (id, config) => {
            const ctx = document.getElementById(id)?.getContext('2d');
            if (ctx) {
                if (window[id + 'Chart']) window[id + 'Chart'].destroy();
                window[id + 'Chart'] = new Chart(ctx, config);
            }
        }
        window.downloadFileFromStream = async (fileName, contentBase64) => {
            const link = document.createElement('a');
            link.download = fileName;
            link.href = "data:application/json;base64," + contentBase64;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        window.initDatePicker = (elementId, initialDate, dotNetHelper) => {
            const el = document.getElementById(elementId);
            if(el) {
                flatpickr(el, {
                    locale: "de", defaultDate: initialDate, dateFormat: "Y-m-d", altInput: true, altFormat: "D, j. F Y", disableMobile: "true",
                    onChange: (selectedDates, dateStr) => dotNetHelper.invokeMethodAsync('OnDateSelected', dateStr)
                });
            }
        };
    </script>
    
    <script src="_framework/blazor.webassembly.js"></script>
</body>
</html>